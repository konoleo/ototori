function getClosestElem(num,arr){return num=Number(num),arr.reduce((prev,curr)=>Math.abs(curr-num)<Math.abs(prev-num)?curr:prev)}const picoAudio=new PicoAudio,fileDiv=document.getElementById("fileDiv"),fileLabel=document.getElementById("fileLabel"),fileInputE=document.getElementById("inputMidi"),main=document.getElementsByTagName("main")[0],timeBar=document.getElementById("timeBar"),coloredLine=document.getElementById("coloredLine"),currentTime=document.getElementById("current"),lengthTime=document.getElementById("length"),skipPrevious=document.getElementById("skipPrevious"),replay5=document.getElementById("replay5"),playPause=document.getElementById("playPause"),forward5=document.getElementById("forward5"),pianoRoll=document.getElementById("pianoroll");var chorusNum=0,scrollAnime,songLengthTimig,minPitch,timeBarTimer;function changeTimeBar(num){timeBar.value=0===num||num?num:Math.round(getCurrentTime()),coloredLine.style.width=`calc((100% - 16px) / ${timeBar.getAttribute("max")} * ${Number(timeBar.value)} + 8px)`,currentTime.textContent=secToMin(Number(timeBar.value))}function secToMin(sec){return Math.floor(sec/60)+":"+(sec%60).toString().padStart(2,"0")}function skip(second,type){const songLengthTime=picoAudio.getTime(songLengthTimig),currentTime=scrollAnime.currentTime/1e3;if("false"===playPause.getAttribute("data-playing")&&playPause.click(),"absolute"===type){var newTimeAbsolute=second;second-=currentTime}if(!(currentTime>=songLengthTime&&1===Math.sign(second))){if(1===Math.sign(second))var newTime=songLengthTime<currentTime+second?songLengthTime:currentTime+second,delaySecond=songLengthTime<currentTime+second?currentTime+second-songLengthTime:second;else var newTime=currentTime+second>0?currentTime+second:0,delaySecond=currentTime>-1*second?second:-1*currentTime;picoAudio.setStartTime(delaySecond),scrollAnime.currentTime=1e3*(newTimeAbsolute||newTime),changeTimeBar(newTimeAbsolute||newTime),document.querySelectorAll(".voice").forEach(elem=>{const left=Number(elem.style.left.replace("px","")),newTiming=picoAudio.getTiming(newTimeAbsolute||newTime);7*left>newTiming?elem.remove():7*(left+Number(elem.style.width.replace("px","")))>newTiming&&(elem.style.width=newTiming/7-left+"px")}),"true"===playPause.getAttribute("data-playing")&&playPause.click()}}function getCurrentTime(){return(picoAudio.context?picoAudio.context.currentTime:0)-picoAudio.states.startTime}fileDiv.style.height=window.innerHeight+"px",main.style.height=window.innerHeight+"px",fileInputE.addEventListener("change",async e=>{const file=e.target.files[0],reader=new FileReader;reader.onload=()=>{const smf=new Uint8Array(reader.result),smfData=picoAudio.parseSMF(smf);picoAudio.setData(smfData),songLengthTimig=smfData.songLength,timeBar.setAttribute("max",Math.round(picoAudio.getTime(songLengthTimig))),lengthTime.textContent=secToMin(Math.round(picoAudio.getTime(songLengthTimig))),pianoRoll.innerHTML="";const mainChannel=smfData.channels[chorusNum],mainPitches=mainChannel.notes.map(note=>note.pitch),min=Math.min(...mainPitches),max=Math.max(...mainPitches);minPitch=7*(min-(pianoRoll.offsetHeight/7-(max-min))/2),mainChannel.notes.forEach(note=>{const newNote=document.createElement("div");newNote.classList.add("note"),newNote.style.left=note.start/7+"px",newNote.style.bottom=7*note.pitch-minPitch+"px",newNote.style.width=(note.stop-note.start)/7+"px",pianoRoll.appendChild(newNote)});let keyframes=[{transform:"translateX(0)",offset:0}];for(let i=0;i<smfData.tempoTrack.length;i++){const nextTempoData=smfData.tempoTrack[i+1];songLengthTimig!==smfData.tempoTrack[i].timing&&keyframes.push({transform:`translateX(${nextTempoData.timing/7*-1}px)`,offset:picoAudio.getTime(nextTempoData.timing)/picoAudio.getTime(songLengthTimig)})}scrollAnime=pianoRoll.animate(keyframes,{duration:1e3*picoAudio.getTime(songLengthTimig),easing:"linear",fill:"forwards"}),pianoRoll.style.width=`${songLengthTimig/7}px`,scrollAnime.pause()},reader.readAsArrayBuffer(file),fileDiv.setAttribute("hidden",""),main.removeAttribute("hidden")},{once:!0}),timeBar.addEventListener("input",()=>{skip(Number(timeBar.value),"absolute")}),playPause.addEventListener("click",()=>{picoAudio.init(),"false"===playPause.getAttribute("data-playing")?(playPause.textContent="pause",playPause.setAttribute("title","停止"),playPause.setAttribute("data-playing","true"),picoAudio.play(),scrollAnime.play(),timeBarTimer=setInterval(changeTimeBar,250)):(playPause.textContent="play_arrow",playPause.setAttribute("title","再生"),playPause.setAttribute("data-playing","false"),picoAudio.pause(),scrollAnime.pause(),clearInterval(timeBarTimer))}),skipPrevious.addEventListener("click",()=>{picoAudio.initStatus(),scrollAnime.cancel(),changeTimeBar(0),document.querySelectorAll(".voice").forEach(elem=>{elem.remove()}),"true"===playPause.getAttribute("data-playing")&&playPause.click()}),replay5.addEventListener("click",()=>{skip(-5)}),forward5.addEventListener("click",()=>{skip(5)}),picoAudio.addEventListener("songEnd",()=>{skipPrevious.click()}),async function(){const freqList=await fetch("freqList.json").then(r=>r.ok?r.json():Promise.reject(new Error(`${r.url}にアクセスできません。`))),stream=await navigator.mediaDevices.getUserMedia({audio:!0}),audioCtx=new AudioContext({sampleRate:44100}),analyser=audioCtx.createAnalyser();analyser.fftSize=16384;const input=audioCtx.createMediaStreamSource(stream);input.connect(analyser);const frequencyData=new Uint8Array(analyser.frequencyBinCount),unit=audioCtx.sampleRate/analyser.fftSize;function voiceToNote(){analyser.getByteFrequencyData(frequencyData);const maxValue=Math.max(...frequencyData),index=frequencyData.indexOf(maxValue);if(maxValue>200&&0!==index){const hz=Math.round(index*unit),closestHz=getClosestElem(hz,Object.keys(freqList)),soundData=freqList[closestHz],newestNote=pianoRoll.querySelector(":scope > .note.voice:last-of-type"),playTiming=picoAudio.getTiming(getCurrentTime());if(newestNote&&Number(newestNote.getAttribute("data-midinote"))===soundData.midinote){const startTiming=Number(newestNote.getAttribute("data-start"));newestNote.style.width=(playTiming-startTiming)/7+"px"}else{const newNote=document.createElement("div");newNote.classList.add("note","voice"),newNote.style.left=playTiming/7+"px",newNote.style.bottom=7*soundData.midinote-minPitch+"px",newNote.style.width=0,newNote.setAttribute("data-midinote",soundData.midinote),newNote.setAttribute("data-start",playTiming),pianoRoll.appendChild(newNote)}}}var timer;picoAudio.addEventListener("play",async()=>{timer=setInterval(voiceToNote,10)}),picoAudio.addEventListener("pause",()=>{clearTimeout(timer)})}();
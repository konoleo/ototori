function getClosestElem(num,arr){return num=Number(num),arr.reduce((prev,curr)=>Math.abs(curr-num)<Math.abs(prev-num)?curr:prev)}const picoAudio=new PicoAudio,controler=document.getElementById("controler"),pianoRoll=document.getElementById("pianoroll");var scrollAnime,minPitch;const fileInputE=document.getElementById("inputMidi");function getCurrentTime(){return(picoAudio.context?picoAudio.context.currentTime:0)-picoAudio.states.startTime}fileInputE.addEventListener("change",async()=>{const file=fileInputE.files[0],reader=new FileReader;reader.onload=()=>{const smf=new Uint8Array(reader.result),smfData=picoAudio.parseSMF(smf);picoAudio.setData(smfData);const mainPitches=smfData.channels[0].notes.map(note=>note.pitch),min=Math.min(...mainPitches),max=Math.max(...mainPitches);minPitch=7*(min-(300/7-(max-min))/2),smfData.channels.forEach((channel,i)=>{channel.notes.forEach(note=>{const newNote=document.createElement("div");newNote.classList.add("note"),0!==i&&newNote.classList.add("hide"),newNote.style.left=note.start/7+"px",newNote.style.bottom=7*note.pitch-minPitch+"px",newNote.style.width=(note.stop-note.start)/7+"px",pianoRoll.appendChild(newNote)})});let keyframes=[{transform:"translateX(0)",offset:0}];for(let i=0;i<smfData.tempoTrack.length;i++){const nextTempoData=smfData.tempoTrack[i+1];smfData.songLength!==smfData.tempoTrack[i].timing&&keyframes.push({transform:`translateX(${nextTempoData.timing/7*-1}px)`,offset:picoAudio.getTime(nextTempoData.timing)/picoAudio.getTime(smfData.songLength)})}scrollAnime=pianoRoll.animate(keyframes,{duration:1e3*picoAudio.getTime(smfData.songLength),easing:"linear",fill:"forwards"}),pianoRoll.style.width=`${smfData.songLength/7}px`,scrollAnime.pause()},reader.readAsArrayBuffer(file),document.getElementById("inputDiv").setAttribute("hidden",""),document.getElementsByTagName("main")[0].removeAttribute("hidden")}),controler.addEventListener("click",()=>{picoAudio.init(),"false"===controler.getAttribute("data-playing")?(controler.textContent="一時停止",controler.setAttribute("data-playing","true"),picoAudio.play(),scrollAnime.play()):(controler.textContent="再生",controler.setAttribute("data-playing","false"),picoAudio.pause(),scrollAnime.pause())}),async function(){const freqList=await fetch("freqList.json").then(r=>r.ok?r.json():Promise.reject(new Error(`${r.url}にアクセスできません。`))),stream=await navigator.mediaDevices.getUserMedia({audio:!0}),audioCtx=new AudioContext({sampleRate:44100}),analyser=audioCtx.createAnalyser();analyser.fftSize=16384;const input=audioCtx.createMediaStreamSource(stream);input.connect(analyser);const frequencyData=new Uint8Array(analyser.frequencyBinCount),unit=audioCtx.sampleRate/analyser.fftSize;function voiceToNote(){analyser.getByteFrequencyData(frequencyData);const maxValue=Math.max(...frequencyData),index=frequencyData.indexOf(maxValue);if(!(maxValue>200&&0!==index))return;{const hz=Math.round(index*unit);var closestHz=getClosestElem(hz,Object.keys(freqList)),soundData=freqList[closestHz]}const newestNote=pianoRoll.querySelector(":scope > .note.voice:last-of-type"),playTime=getCurrentTime();if(newestNote&&Number(newestNote.getAttribute("data-midinote"))===soundData.midinote){const startTime=Number(newestNote.style.left.replace("px",""));console.log(7*(playTime-startTime)),newestNote.style.width=Number(newestNote.style.width.replace("px",""))+7*(playTime-startTime)+"px",console.log(soundData.japanese)}else{const newNote=document.createElement("div");newNote.classList.add("note","voice"),newNote.style.left=picoAudio.getTiming(playTime)/7+"px",newNote.style.bottom=7*soundData.midinote-minPitch+"px",newNote.style.width=0,newNote.setAttribute("data-midinote",soundData.midinote),pianoRoll.appendChild(newNote)}}var timer;picoAudio.addEventListener("play",async()=>{timer=setInterval(voiceToNote,10)}),picoAudio.addEventListener("pause",()=>{clearTimeout(timer)})}();
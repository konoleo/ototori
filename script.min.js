function getClosestElem(num,arr){return num=Number(num),arr.reduce((prev,curr)=>Math.abs(curr-num)<Math.abs(prev-num)?curr:prev)}const fileDiv=document.getElementById("fileDiv"),fileLabel=document.getElementById("fileLabel"),fileInputE=document.getElementById("inputMidi"),controlers=document.getElementById("controlers"),picoAudio=new PicoAudio,playPause=document.getElementById("playPause"),skipPrevious=document.getElementById("skipPrevious"),replay5=document.getElementById("replay5"),pianoRoll=document.getElementById("pianoroll");var chorusNum=0,scrollAnime,minPitch;async function readMidi(e){const file=e.target.files[0],reader=new FileReader;reader.onload=()=>{const smf=new Uint8Array(reader.result),smfData=picoAudio.parseSMF(smf);picoAudio.setData(smfData),pianoRoll.innerHTML="";const mainChannel=smfData.channels[chorusNum],mainPitches=mainChannel.notes.map(note=>note.pitch),min=Math.min(...mainPitches),max=Math.max(...mainPitches);minPitch=7*(min-(300/7-(max-min))/2),mainChannel.notes.forEach(note=>{const newNote=document.createElement("div");newNote.classList.add("note"),newNote.style.left=note.start/7+"px",newNote.style.bottom=7*note.pitch-minPitch+"px",newNote.style.width=(note.stop-note.start)/7+"px",pianoRoll.appendChild(newNote)});let keyframes=[{transform:"translateX(0)",offset:0}];for(let i=0;i<smfData.tempoTrack.length;i++){const nextTempoData=smfData.tempoTrack[i+1];smfData.songLength!==smfData.tempoTrack[i].timing&&keyframes.push({transform:`translateX(${nextTempoData.timing/7*-1}px)`,offset:picoAudio.getTime(nextTempoData.timing)/picoAudio.getTime(smfData.songLength)})}scrollAnime=pianoRoll.animate(keyframes,{duration:1e3*picoAudio.getTime(smfData.songLength),easing:"linear",fill:"forwards"}),pianoRoll.style.width=`${smfData.songLength/7}px`,scrollAnime.pause()},reader.readAsArrayBuffer(file)}function getCurrentTiming(){return(picoAudio.context?picoAudio.getTiming(picoAudio.context.currentTime):0)-picoAudio.getTiming(picoAudio.states.startTime)}fileDiv.style.height=window.innerHeight+"px",fileInputE.addEventListener("change",e=>{readMidi(e),fileDiv.setAttribute("hidden",""),document.getElementsByTagName("main")[0].removeAttribute("hidden"),fileLabel.innerHTML=fileLabel.innerHTML.replace("ファイルを選択","別の曲を練習する"),controlers.appendChild(fileLabel),document.querySelector("#controlers #inputMidi").addEventListener("change",e=>readMidi(e))},{once:!0}),playPause.addEventListener("click",()=>{picoAudio.init(),"false"===playPause.getAttribute("data-playing")?(playPause.textContent="pause",playPause.setAttribute("title","停止"),playPause.setAttribute("data-playing","true"),picoAudio.play(),scrollAnime.play()):(playPause.textContent="play_arrow",playPause.setAttribute("title","再生"),playPause.setAttribute("data-playing","false"),picoAudio.pause(),scrollAnime.pause())}),skipPrevious.addEventListener("click",()=>{picoAudio.init(),picoAudio.initStatus(),scrollAnime.cancel(),document.querySelectorAll(".voice").forEach(elem=>{elem.remove()}),"true"===playPause.getAttribute("data-playing")&&playPause.click()}),replay5.addEventListener("click",()=>{const test=scrollAnime.currentTime;let before5Time=test-5e3;before5Time<0&&(before5Time=0),scrollAnime.currentTime=before5Time,scrollAnime.startTime=before5Time,picoAudio.setStartTime(before5Time),console.log("scrollAnime.currentTime: ",test),console.log("scrollAnime.currentTime: ",scrollAnime.currentTime),document.querySelectorAll(".voice").forEach(elem=>{7*Number(elem.style.left.replace("px",""))>picoAudio.getTiming(before5Time)&&elem.remove()}),"true"===playPause.getAttribute("data-playing")&&playPause.click()}),async function(){const freqList=await fetch("freqList.json").then(r=>r.ok?r.json():Promise.reject(new Error(`${r.url}にアクセスできません。`))),stream=await navigator.mediaDevices.getUserMedia({audio:!0}),audioCtx=new AudioContext({sampleRate:44100}),analyser=audioCtx.createAnalyser();analyser.fftSize=16384;const input=audioCtx.createMediaStreamSource(stream);input.connect(analyser);const frequencyData=new Uint8Array(analyser.frequencyBinCount),unit=audioCtx.sampleRate/analyser.fftSize;function voiceToNote(){analyser.getByteFrequencyData(frequencyData);const maxValue=Math.max(...frequencyData),index=frequencyData.indexOf(maxValue);if(maxValue>200&&0!==index){const hz=Math.round(index*unit),closestHz=getClosestElem(hz,Object.keys(freqList)),soundData=freqList[closestHz],newestNote=pianoRoll.querySelector(":scope > .note.voice:last-of-type"),playTiming=getCurrentTiming();if(newestNote&&Number(newestNote.getAttribute("data-midinote"))===soundData.midinote){const startTiming=Number(newestNote.getAttribute("data-start"));newestNote.style.width=(playTiming-startTiming)/7+"px"}else{const newNote=document.createElement("div");newNote.classList.add("note","voice"),newNote.style.left=playTiming/7+"px",newNote.style.bottom=7*soundData.midinote-minPitch+"px",newNote.style.width=0,newNote.setAttribute("data-midinote",soundData.midinote),newNote.setAttribute("data-start",playTiming),pianoRoll.appendChild(newNote)}}}var timer;picoAudio.addEventListener("play",async()=>{timer=setInterval(voiceToNote,10)}),picoAudio.addEventListener("pause",()=>{clearTimeout(timer)})}();
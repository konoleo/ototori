const picoAudio=new PicoAudio,fileDiv=document.getElementById("fileDiv"),fileLabel=document.getElementsByClassName("fileLabel"),fileInputE=document.getElementsByClassName("inputJson"),main=document.getElementsByTagName("main")[0],title=document.getElementById("title"),pianoRoll=document.getElementById("pianoroll"),lyricsE=document.getElementById("lyrics"),dynamicsE=document.getElementById("dynamics"),timeBar=document.getElementById("timeBar"),coloredLine=document.getElementById("coloredLine"),currentTimeE=document.getElementById("current"),lengthTimeE=document.getElementById("length"),skipPrevious=document.getElementById("skipPrevious"),replay5=document.getElementById("replay5"),playPause=document.getElementById("playPause"),forward5=document.getElementById("forward5");var chorusNum,lyricsData,scrollAnime,tempos,songLengthTimig,minPitch;function readFile(e){const file=e.target.files[0],reader=new FileReader;reader.readAsText(file),reader.onload=()=>{picoAudio.init();const json=JSON.parse(reader.result),smf=new Uint8Array(base64ToUint8Array(json.midi_base64)),smfData=picoAudio.parseSMF(smf);title.textContent=json.title,chorusNum=json.chorusChannel,lyricsData=json.lyrics,picoAudio.setData(smfData),songLengthTimig=smfData.songLength,timeBar.setAttribute("max",Math.round(picoAudio.getTime(songLengthTimig))),lengthTimeE.textContent=secToMin(Math.round(picoAudio.getTime(songLengthTimig))),pianoRoll.innerHTML="";const mainChannel=smfData.channels[chorusNum],mainPitches=mainChannel.notes.map(note=>note.pitch),min=Math.min(...mainPitches),max=Math.max(...mainPitches);minPitch=7*(min-(pianoRoll.offsetHeight/7-(max-min))/2),mainChannel.notes.forEach(note=>{const newNote=document.createElement("div");newNote.classList.add("note"),newNote.style.left=note.start/7+"px",newNote.style.bottom=7*note.pitch-minPitch+"px",newNote.style.width=(note.stop-note.start)/7+"px",newNote.setAttribute("data-start",note.start),newNote.setAttribute("data-stop",note.stop),pianoRoll.appendChild(newNote)});let keyframes=[{transform:"translateX(0)",offset:0}];tempos=smfData.tempoTrack;for(let i=0;i<tempos.length;i++){const nextTempoData=tempos[i+1];songLengthTimig!==tempos[i].timing&&keyframes.push({transform:`translateX(${nextTempoData.timing/7*-1}px)`,offset:picoAudio.getTime(nextTempoData.timing)/picoAudio.getTime(songLengthTimig)})}scrollAnime=pianoRoll.animate(keyframes,{duration:1e3*picoAudio.getTime(songLengthTimig),easing:"linear",fill:"forwards"}),pianoRoll.style.width=`${songLengthTimig/7}px`,skipPrevious.click(),scrollAnime.pause(),scrollAnime.oncancel=()=>{scrollAnime.play(),scrollAnime.pause()},displayLyricsSigns(0)}}function base64ToUint8Array(base64Str){const raw=atob(base64Str);return Uint8Array.from(Array.prototype.map.call(raw,x=>x.charCodeAt(0)))}function displayLyricsSigns(timing){const currentTiming=void 0!==timing?timing:picoAudio.getTiming(getCurrentTime()),lyricIndex=getBiggerClosestNum(currentTiming,lyricsData.map(elem=>elem.endTiming));for(let i=0;i<lyricsE.children.length;i++){const elem=lyricsE.children[i];if(lyricsData.length-1<lyricIndex+i||-1===lyricIndex)elem.innerHTML="&nbsp;",elem.classList.remove("active");else{const data=lyricsData[lyricIndex+i];elem.textContent=data.lyric,data.startTiming<=currentTiming&&currentTiming<=data.endTiming?elem.classList.add("active"):elem.classList.remove("active")}}}function getBiggerClosestNum(num,arr){num=Number(num);const value=Math.min(...arr.filter(elem=>elem>num));return arr.indexOf(value)}fileDiv.style.height=window.innerHeight+"px",main.style.height=window.innerHeight+"px",fileInputE[0].addEventListener("change",e=>{readFile(e),fileDiv.setAttribute("hidden",""),main.removeAttribute("hidden"),fileInputE[1].addEventListener("change",e=>{readFile(e)})},{once:!0});const dynamicsToUnicode={ppp:{unicode:"&#xE52A;",num:-4},pp:{unicode:"&#xE52B;",num:-3},p:{unicode:"&#xE520;",num:-2},mp:{unicode:"&#xE52C;",num:-1},mf:{unicode:"&#xE52D;",num:1},f:{unicode:"&#xE522;",num:2},ff:{unicode:"&#xE52F;",num:3},fff:{unicode:"&#xE530;",num:4},cresc:"&#xE53E;",decresc:"&#xE53F;"};var timeBarTimer,lyricsSignsTimer;function changeTimeBar(num){timeBar.value=0===num||num?num:Math.round(getCurrentTime()),coloredLine.style.width=`calc((100% - 16px) / ${timeBar.getAttribute("max")} * ${Number(timeBar.value)} + 8px)`,currentTimeE.textContent=secToMin(Number(timeBar.value))}function secToMin(sec){return Math.floor(sec/60)+":"+(sec%60).toString().padStart(2,"0")}function skip(second,type,eventName){"input"!==eventName||timeBar.hasAttribute("data-playing")||(timeBar.setAttribute("data-playing",playPause.getAttribute("data-playing")),"true"===playPause.getAttribute("data-playing")&&playPause.click());const songLengthTime=picoAudio.getTime(songLengthTimig),currentTime=scrollAnime.currentTime/1e3,playing=playPause.getAttribute("data-playing");if(currentTime>=songLengthTime&&1===Math.sign(second))skipPrevious.click();else{if("false"===playPause.getAttribute("data-playing")&&playPause.click(),"absolute"===type){var newTimeAbsolute=second;second-=currentTime}if(1===Math.sign(second))var newTime=songLengthTime<currentTime+second?songLengthTime:currentTime+second,delaySecond=songLengthTime<currentTime+second?currentTime+second-songLengthTime:second;else var newTime=currentTime+second>0?currentTime+second:0,delaySecond=currentTime>-1*second?second:-1*currentTime;picoAudio.setStartTime(delaySecond),scrollAnime.currentTime=1e3*(newTimeAbsolute||newTime),changeTimeBar(newTimeAbsolute||newTime),displayLyricsSigns(),document.querySelectorAll(".voice").forEach(elem=>{const left=Number(elem.style.left.replace("px","")),newTiming=picoAudio.getTiming(newTimeAbsolute||newTime);7*left>newTiming?elem.remove():7*(left+Number(elem.style.width.replace("px","")))>newTiming&&(elem.style.width=newTiming/7-left+"px")}),"true"===playPause.getAttribute("data-playing")&&playPause.click(),"true"===playing&&playPause.click(),"change"===eventName&&("true"===timeBar.getAttribute("data-playing")&&playPause.click(),timeBar.removeAttribute("data-playing"))}}function getClosestNum(num,arr){return num=Number(num),arr.reduce((prev,curr)=>Math.abs(curr-num)<Math.abs(prev-num)?curr:prev)}function getCurrentTime(){return(picoAudio.context?picoAudio.context.currentTime:0)-picoAudio.states.startTime}playPause.addEventListener("click",()=>{picoAudio.init(),"false"===playPause.getAttribute("data-playing")?(playPause.textContent="pause",playPause.setAttribute("title","停止"),playPause.setAttribute("data-playing","true"),picoAudio.play(),scrollAnime.play(),timeBarTimer=setInterval(changeTimeBar,250),lyricsSignsTimer=setInterval(displayLyricsSigns,100)):(playPause.textContent="play_arrow",playPause.setAttribute("title","再生"),playPause.setAttribute("data-playing","false"),picoAudio.pause(),scrollAnime.pause(),clearInterval(timeBarTimer),clearInterval(lyricsSignsTimer))}),timeBar.addEventListener("input",()=>{skip(Number(timeBar.value),"absolute","input")}),timeBar.addEventListener("change",()=>{skip(Number(timeBar.value),"absolute","change")}),skipPrevious.addEventListener("click",()=>{picoAudio.initStatus(),scrollAnime.cancel(),displayLyricsSigns(0),changeTimeBar(0),document.querySelectorAll(".voice").forEach(elem=>{elem.remove()}),"true"===playPause.getAttribute("data-playing")&&playPause.click()}),replay5.addEventListener("click",()=>{skip(-5)}),forward5.addEventListener("click",()=>{skip(5)}),picoAudio.addEventListener("songEnd",()=>{skipPrevious.click()}),async function(){const freqList=await fetch("freqList.json").then(r=>r.ok?r.json():Promise.reject(new Error(`${r.url}にアクセスできません。`))),stream=await navigator.mediaDevices.getUserMedia({audio:!0}),audioCtx=new AudioContext({sampleRate:44100}),analyser=audioCtx.createAnalyser();analyser.fftSize=16384;const input=audioCtx.createMediaStreamSource(stream);input.connect(analyser);const frequencyData=new Uint8Array(analyser.frequencyBinCount),unit=audioCtx.sampleRate/analyser.fftSize;function voiceToNote(){analyser.getByteFrequencyData(frequencyData);const maxValue=Math.max(...frequencyData),index=frequencyData.indexOf(maxValue);if(maxValue>200&&0!==index){const hz=Math.round(index*unit),closestHz=getClosestNum(hz,Object.keys(freqList)),soundData=freqList[closestHz],newestNote=pianoRoll.querySelector(":scope > .note.voice:last-of-type"),currentTime=getCurrentTime(),correctionTime=5e-4*tempos.filter(tempo=>tempo.time<currentTime&&tempo.value).slice(-1)[0].value+.2883,playTiming=picoAudio.getTiming(currentTime-correctionTime);if(!newestNote||playTiming-Number(newestNote.getAttribute("data-end"))>100||Number(newestNote.getAttribute("data-midinote"))!==soundData.midinote){const newNote=document.createElement("div");newNote.classList.add("note","voice"),newNote.style.left=playTiming/7+"px",newNote.style.bottom=7*soundData.midinote-minPitch+"px",newNote.style.width=0,newNote.setAttribute("data-midinote",soundData.midinote),newNote.setAttribute("data-start",playTiming),newNote.setAttribute("data-end",playTiming),pianoRoll.appendChild(newNote)}else{const startTiming=Number(newestNote.getAttribute("data-start"));newestNote.style.width=(playTiming-startTiming)/7+"px",newestNote.setAttribute("data-end",startTiming+7*Number(newestNote.style.width.replace("px","")))}}}var timer;picoAudio.addEventListener("play",()=>{timer=setInterval(voiceToNote,10)}),picoAudio.addEventListener("pause",()=>{clearTimeout(timer)})}();
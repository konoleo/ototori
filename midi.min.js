const picoAudio=new PicoAudio,controler=document.getElementById("controler"),pianoRoll=document.getElementById("pianoroll");var scrollAnime;const fileInputE=document.getElementById("inputMidi");fileInputE.addEventListener("change",()=>{const file=fileInputE.files[0],reader=new FileReader;reader.onload=()=>{const smf=new Uint8Array(reader.result),smfData=picoAudio.parseSMF(smf);picoAudio.setData(smfData);const pitches=smfData.channels[0].notes.map(note=>note.pitch),min=Math.min(...pitches),max=Math.max(...pitches),minPitch=7*(min-(300/7-(max-min))/2);smfData.channels.forEach((channel,i)=>{channel.notes.forEach(note=>{const newNote=document.createElement("div");newNote.classList.add("note"),0!==i&&newNote.classList.add("hide"),newNote.style.bottom=7*note.pitch-minPitch+"px",newNote.style.left=note.start/7+"px",newNote.style.width=(note.stop-note.start)/7+"px",pianoRoll.appendChild(newNote)})});let keyframes=[{transform:"translateX(0)",offset:0}];for(let i=0;i<smfData.tempoTrack.length;i++){const nextTempoData=smfData.tempoTrack[i+1];smfData.songLength!==smfData.tempoTrack[i].timing&&keyframes.push({transform:`translateX(${nextTempoData.timing/7*-1}px)`,offset:picoAudio.getTime(nextTempoData.timing)/picoAudio.getTime(smfData.songLength)})}scrollAnime=pianoRoll.animate(keyframes,{duration:1e3*picoAudio.getTime(smfData.songLength),easing:"linear",fill:"forwards"}),pianoRoll.style.width=`${smfData.songLength/7}px`,scrollAnime.pause(),controler.removeAttribute("disabled")},reader.readAsArrayBuffer(file)}),controler.addEventListener("click",()=>{picoAudio.init(),"false"===controler.getAttribute("data-playing")?(controler.textContent="一時停止",controler.setAttribute("data-playing","true"),picoAudio.play(),scrollAnime.play()):(controler.textContent="再生",controler.setAttribute("data-playing","false"),picoAudio.pause(),scrollAnime.pause())});
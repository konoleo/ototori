function getClosestElem(num,arr){return num=Number(num),arr.reduce((prev,curr)=>Math.abs(curr-num)<Math.abs(prev-num)?curr:prev)}const notes=document.getElementById("notes");!async function(){const freqList=await fetch("freqList.json").then(r=>r.ok?r.json():Promise.reject(new Error(`${r.url}にアクセスできません。`)));window.addEventListener("click",()=>{navigator.mediaDevices.getUserMedia({audio:!0}).then(stream=>{const audioCtx=new AudioContext({sampleRate:44100}),analyser=audioCtx.createAnalyser();analyser.fftSize=16384;const input=audioCtx.createMediaStreamSource(stream);input.connect(analyser);const frequencyData=new Uint8Array(analyser.frequencyBinCount),javascriptNode=audioCtx.createScriptProcessor(2048);analyser.connect(javascriptNode),javascriptNode.connect(audioCtx.destination);const unit=audioCtx.sampleRate/analyser.fftSize;javascriptNode.addEventListener("audioprocess",()=>{analyser.getByteFrequencyData(frequencyData);const maxValue=Math.max(...frequencyData),index=frequencyData.indexOf(maxValue);if(maxValue>200&&0!==index){const hz=Math.round(index*unit);document.getElementById("freq").style.left=hz+"px";var closestHz=getClosestElem(hz,Object.keys(freqList)),soundData=freqList[closestHz]}else{document.getElementById("freq").style.left="0px";var soundData={japanese:"休み",international:"rest"}}const newestNote=notes.querySelector(":scope > .note:last-of-type");if(newestNote&&newestNote.getAttribute("data-international")===soundData.international)newestNote.style.width=Number(newestNote.style.width.replace("px",""))+.5+"px",console.log(newestNote.style.width);else{const newNote=document.createElement("div");newNote.classList.add("note"),newNote.textContent=`${soundData.japanese} (${closestHz||soundData.international})`,newNote.setAttribute("data-international",soundData.international),newNote.style.width=0,notes.appendChild(newNote)}})})})}();